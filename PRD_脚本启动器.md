# 产品需求文档：Paper Project 脚本启动器

> 版本：v1.0  
> 创建日期：2026-01-15  
> 状态：开发中

---

## 1. 产品概述

### 1.1 产品名称
Paper Project 脚本启动器（暂定名）

### 1.2 产品定位
一个绿色版（免安装）的Windows桌面工具，用于：
- 可视化管理和启动 Paper Project 中的 Python 脚本
- 连接数据库并渲染股票K线图
- 提供统一的操作界面，提升研究效率

### 1.3 目标用户
项目作者本人（单用户工具）

---

## 2. 功能需求

### 2.1 界面布局

```
┌─────────────────────────────────────────────────────────────────────────┐
│  📊 Paper Project 脚本启动器                                 ─  □  ✕   │
├───────────────────────────────────────────────────┬─────────────────────┤
│                                                   │                     │
│                                                   │  [测试连接]         │
│                                                   │                     │
│                                                   │  [富途连接]         │
│                                                   │                     │
│              K线图显示区域                         │  [数据收集]         │
│                                                   │                     │
│         （从数据库读取数据渲染）                    │  [K线历史]          │
│                                                   │                     │
│                                                   │  [腾讯数据]         │
│                                                   │                     │
│                                                   │  [数据检查]         │
│                                                   │                     │
│                                                   │  [数据清洗]         │
│                                                   │                     │
├───────────────────────────────────────────────────┤  [特征计算]         │
│  时间窗口: [日K ▼]  股票: [HK.00700 ▼]  [刷新]    │                     │
├───────────────────────────────────────────────────┤  [数据集构建]       │
│                                                   │                     │
│  输出日志区域                                      │  [模型训练]         │
│  > [14:32:05] 正在执行...                         │                     │
│  > [14:32:07] 执行完成                            │  [策略回测]         │
│                                                   │                     │
│                                                   │  [模拟交易]         │
│                                                   │                     │
│                                                   │  [SHAP分析]         │
│                                                   │                     │
└───────────────────────────────────────────────────┴─────────────────────┘
```

**布局说明：**
- 左侧：K线图显示区（上）+ 日志输出区（下）
- 右侧：脚本按钮列表（垂直排列）

### 2.2 核心功能

#### 2.2.1 K线图显示
| 功能项 | 描述 | 优先级 |
|-------|------|--------|
| 数据库连接 | 连接本地/远程数据库读取K线数据 | P0 |
| K线渲染 | 显示蜡烛图（开高低收） | P0 |
| 时间窗口切换 | 支持：日K、周K、月K、60分钟、30分钟、15分钟、5分钟、1分钟 | P0 |
| 股票切换 | 下拉选择不同股票代码 | P0 |
| 成交量 | K线下方显示成交量柱状图 | P1 |
| 均线叠加 | MA5、MA10、MA20等移动平均线 | P1 |
| 图表交互 | 鼠标滚轮缩放、拖拽平移 | P2 |

#### 2.2.2 脚本启动
| 功能项 | 描述 | 优先级 |
|-------|------|--------|
| 按钮启动 | 点击按钮运行对应Python脚本 | P0 |
| 实时日志 | 脚本输出实时显示在日志区 | P0 |
| 运行状态 | 按钮显示运行中/完成/失败状态 | P1 |
| 终止脚本 | 可中断正在运行的脚本 | P2 |

#### 2.2.3 数据连接
| 功能项 | 描述 | 优先级 |
|-------|------|--------|
| 数据库配置 | 配置数据库连接参数（host、port、user、password、database） | P0 |
| 富途API配置 | 配置OpenD连接参数（host、port） | P0 |
| 配置持久化 | 保存配置到本地文件，下次启动自动加载 | P0 |

---

## 3. 技术方案

### 3.1 技术栈选型

| 组件 | 技术选型 | 说明 |
|------|---------|------|
| GUI框架 | CustomTkinter | 现代化UI，基于Tkinter |
| K线渲染 | mplfinance + matplotlib | 专业金融图表，可嵌入Tkinter |
| 数据库 | pymysql / psycopg2 | 取决于现有数据库类型 |
| 富途API | futu-api | 官方Python SDK |
| 打包工具 | PyInstaller | 生成单文件exe |

### 3.2 关于富途OpenD

> ⚠️ **重要说明**

富途官方API架构如下：

```
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│  Python程序  │ <--> │    OpenD     │ <--> │  富途服务器  │
│  (futu-api)  │      │  (本地网关)  │      │   (云端)     │
└──────────────┘      └──────────────┘      └──────────────┘
```

**OpenD是必须的中间层**，无法绕过。但可以优化用户体验：

| 方案 | 描述 | 推荐度 |
|-----|------|--------|
| 方案A：手动启动 | 用户先打开OpenD桌面程序，再使用本工具 | ⭐⭐ |
| 方案B：自动启动 | 工具启动时自动检测并启动OpenD（后台静默） | ⭐⭐⭐⭐ |
| 方案C：内嵌OpenD | 将OpenD打包进工具（需富途授权，不推荐） | ⭐ |

**建议采用方案B**：
- 配置OpenD安装路径
- 启动时检测OpenD是否运行
- 若未运行，自动启动OpenD（最小化/隐藏窗口）
- 等待连接就绪后再操作

### 3.3 富途OpenD路径（已确认）

```
c:\Users\12995\Downloads\Futu_OpenD_9.6.5618_Windows\Futu_OpenD_9.6.5618_Windows\Futu_OpenD_9.6.5618_Windows\
├── FutuOpenD.exe      # 主程序
├── FutuOpenD.xml      # 配置文件（需填写账号密码）
└── ...其他依赖文件
```

**FutuOpenD.xml 关键配置：**
```xml
<ip>127.0.0.1</ip>           <!-- API监听地址 -->
<api_port>11111</api_port>   <!-- API端口 -->
<login_account>你的账号</login_account>   <!-- 富途账号/手机号/邮箱 -->
<login_pwd>你的密码</login_pwd>           <!-- 登录密码 -->
```

### 3.4 配置文件设计

```json
{
  "database": {
    "type": "mysql",
    "host": "localhost",
    "port": 3306,
    "user": "root",
    "password": "******",
    "database": "stock_data"
  },
  "futu": {
    "opend_path": "c:/Users/12995/Downloads/Futu_OpenD_9.6.5618_Windows/Futu_OpenD_9.6.5618_Windows/Futu_OpenD_9.6.5618_Windows/FutuOpenD.exe",
    "host": "127.0.0.1",
    "port": 11111,
    "auto_start": true
  },
  "display": {
    "default_stock": "HK.00700",
    "default_ktype": "K_DAY"
  }
}
```

---

## 4. 脚本清单

以下是需要通过按钮启动的脚本：

| 序号 | 按钮名称 | 脚本文件 | 功能描述 |
|-----|---------|---------|---------|
| 1 | 测试连接 | 03_test_connection.py | 测试数据库连接 |
| 2 | 富途连接 | 05_test_futu_connection.py | 测试富途API连接 |
| 3 | 数据收集 | 06_data_collector.py | 收集股票数据 |
| 4 | K线历史 | 08_fetch_kline_history.py | 获取历史K线数据 |
| 5 | 腾讯数据 | 09_collect_tencent.py | 从腾讯获取数据 |
| 6 | 数据检查 | 07_check_data.py | 检查数据完整性 |
| 7 | 数据清洗 | 10_data_cleaner.py | 清洗异常数据 |
| 8 | 特征计算 | 11_feature_calculator.py | 计算技术指标特征 |
| 9 | 数据集构建 | 12_dataset_builder.py | 构建训练数据集 |
| 10 | 模型训练 | 13_model_trainer.py | 训练预测模型 |
| 11 | 策略回测 | 14_backtest.py | 回测交易策略 |
| 12 | 模拟交易 | 15_paper_trader.py | 模拟盘交易 |
| 13 | SHAP分析 | 16_shap_analysis.py | 模型可解释性分析 |

---

## 5. 已确认信息

### 5.1 数据库配置（已确认）

| 配置项 | 值 |
|-------|-----|
| 数据库类型 | PostgreSQL + TimescaleDB |
| Host | localhost |
| Port | 5433 |
| Database | futu_ofi |
| User | postgres |
| Password | ofi123456 |

**K线数据表 `kline` 结构：**
```sql
CREATE TABLE kline (
    ts TIMESTAMP,          -- 时间戳
    code VARCHAR(20),      -- 股票代码 (如 HK.00700)
    ktype VARCHAR(10),     -- K线类型 (K_1M, K_5M, K_60M, K_DAY)
    open_price FLOAT,      -- 开盘价
    high_price FLOAT,      -- 最高价
    low_price FLOAT,       -- 最低价
    close_price FLOAT,     -- 收盘价
    volume BIGINT,         -- 成交量
    turnover FLOAT,        -- 成交额
    turnover_rate FLOAT,   -- 换手率
    pe_ratio FLOAT,        -- 市盈率
    change_rate FLOAT,     -- 涨跌幅
    last_close FLOAT,      -- 昨收价
    PRIMARY KEY (ts, code, ktype)
);
```

**已有股票数据：**
- HK.00700 (腾讯控股)
- HK.HSI (恒生指数)

### 5.2 富途OpenD（已确认）

| 配置项 | 值 |
|-------|-----|
| 安装路径 | `c:\Users\12995\Downloads\Futu_OpenD_9.6.5618_Windows\...\FutuOpenD.exe` |
| API地址 | 127.0.0.1 |
| API端口 | 11111 |

### 5.3 界面配置（已确认）

| 配置项 | 值 |
|-------|-----|
| 窗口大小 | 1400 x 900 |
| 主题风格 | 深色主题 |
| K线数据源 | 数据库历史 + 实时行情推送 |

### 5.4 脚本参数

当前所有脚本的配置都是**硬编码**在脚本内部的（如股票列表、日期范围等），暂不需要GUI传参。

如有需要，后续可扩展：在按钮旁添加输入框，支持传入参数。

---

## 6. 版本规划

### v1.0 - 基础版本（当前开发）

**界面布局：**
```
┌─────────────────────────────────────────────────────────────────────────┐
│  📊 Paper Project 脚本启动器 v1.0                            ─  □  ✕   │
├───────────────────────────────────────────────────┬─────────────────────┤
│                                                   │  ── 数据连接 ──     │
│              日历视图                              │  [数据库连接]       │
│                                                   │  [富途连接]         │
│     显示每个交易日的数据采集量                      │                     │
│     （按月份展示，颜色深浅表示数据量）              │  ── 数据采集 ──     │
│                                                   │  [腾讯数据]         │
│                                                   │                     │
│                                                   │  ── 占位功能 ──     │
│                                                   │  [数据检查] (灰)    │
├───────────────────────────────────────────────────┤  [数据清洗] (灰)    │
│  数据统计:                                        │  [特征计算] (灰)    │
│  总记录数: 125,000 | 股票数: 2 | 最新: 2026-01-15 │  [数据集构建] (灰)  │
├───────────────────────────────────────────────────┤  [模型训练] (灰)    │
│                                                   │  [策略回测] (灰)    │
│  输出日志区域                                      │  [模拟交易] (灰)    │
│  > [14:32:05] 正在执行 09_collect_tencent.py...   │  [SHAP分析] (灰)    │
│  > [14:32:07] 获取 HK.00700 数据成功              │                     │
│                                                   │                     │
└───────────────────────────────────────────────────┴─────────────────────┘
```

**功能清单：**

| 功能 | 描述 | 状态 |
|-----|------|------|
| 窗口框架 | 1400x900 深色主题，左右布局 | ✅ 完成 |
| 数据库连接 | 测试PostgreSQL连接，显示连接状态 | ✅ 完成 |
| 富途连接 | 测试API连接，显示连接状态 | ✅ 完成 |
| 腾讯数据采集 | 运行09_collect_tencent.py，实时显示日志 | ✅ 完成 |
| 日历视图 | 按月显示，每个交易日格子显示数据量 | ✅ 完成 |
| 数据统计 | 实时显示总记录数、股票数、最新日期 | ✅ 完成 |
| 占位按钮 | 其他脚本按钮灰色显示，点击无响应 | ✅ 完成 |

---

### v1.1 - K线功能（后续）

| 功能 | 描述 | 状态 |
|-----|------|------|
| K线渲染 | mplfinance蜡烛图 | 待开发 |
| 时间窗口切换 | 日K/周K/分钟K | 待开发 |
| 股票切换 | 下拉选择 | 待开发 |
| 实时行情 | 富途推送更新K线 | 待开发 |

---

### v1.2 - 完整脚本（后续）

| 功能 | 描述 | 状态 |
|-----|------|------|
| 数据检查 | 07_check_data.py | 待开发 |
| 数据清洗 | 10_data_cleaner.py | 待开发 |
| 特征计算 | 11_feature_calculator.py | 待开发 |
| 数据集构建 | 12_dataset_builder.py | 待开发 |
| 模型训练 | 13_model_trainer.py | 待开发 |
| 策略回测 | 14_backtest.py | 待开发 |
| 模拟交易 | 15_paper_trader.py | 待开发 |
| SHAP分析 | 16_shap_analysis.py | 待开发 |

---

### v2.0 - 打包发布（后续）

| 功能 | 描述 | 状态 |
|-----|------|------|
| PyInstaller打包 | 生成单文件exe | 待开发 |
| 绿色版测试 | 无需安装运行 | 待开发 |

---

## 修订记录

| 版本 | 日期 | 修改内容 |
|-----|------|---------|
| v0.1 | 2026-01-15 | 初稿，需求收集中 |
| v1.0 | 2026-01-15 | 确定v1.0范围：数据连接+腾讯采集+日历视图 |

