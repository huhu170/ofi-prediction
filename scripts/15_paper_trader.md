# 模拟交易方案说明

> 对应脚本：`15_paper_trader.py`  
> 版本：v1.0  
> 更新日期：2026-01-14

---

## 1. 概述

本模块实现基于OFI预测模型的自动化模拟交易，支持在富途PC端实时查看交易记录和持仓。

### 1.1 交易流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    模拟交易流程                                  │
├─────────────────────────────────────────────────────────────────┤
│  1. 加载训练好的模型 (Transformer/LSTM/等)                       │
│                                                                 │
│  2. 连接富途OpenAPI (模拟账户)                                   │
│                                                                 │
│  3. 订阅实时行情 (订单簿)                                        │
│                                                                 │
│  4. 实时计算特征                                                │
│     └─ 维护100步滑动窗口                                        │
│                                                                 │
│  5. 模型预测                                                    │
│     └─ 输出: 下跌/平稳/上涨 + 置信度                            │
│                                                                 │
│  6. 风控检查                                                    │
│     └─ 仓位限制、止损止盈、冷却时间                              │
│                                                                 │
│  7. 执行下单                                                    │
│     └─ 买入/卖出 → 富途模拟账户                                 │
│                                                                 │
│  8. PC端查看                                                    │
│     └─ 富途牛牛 → 持仓/订单记录                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 核心功能

| 功能 | 说明 |
|------|------|
| 实时预测 | 每10秒生成一次交易信号 |
| 自动下单 | 根据信号自动买入/卖出 |
| 风控管理 | 仓位限制、止损止盈、冷却时间 |
| PC端同步 | 交易记录在富途牛牛实时显示 |
| 模拟运行 | 支持干跑模式（不实际下单）|

---

## 2. 配置说明

### 2.1 交易配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| market | HK | 港股市场 |
| env | SIMULATE | 模拟环境 |
| max_position_pct | 30% | 单只股票最大仓位 |
| stop_loss_pct | 2% | 止损比例 |
| take_profit_pct | 5% | 止盈比例 |
| min_confidence | 60% | 最小预测置信度 |
| cooldown_seconds | 60 | 同方向交易冷却时间 |

### 2.2 信号生成规则

```python
# 模型输出概率
probs = [P(下跌), P(平稳), P(上涨)]

# 信号生成
if max(probs) < 0.6:
    signal = 'HOLD'  # 置信度不足
elif argmax(probs) == 2:
    signal = 'BUY'   # 预测上涨
elif argmax(probs) == 0:
    signal = 'SELL'  # 预测下跌
else:
    signal = 'HOLD'  # 预测平稳
```

### 2.3 风控规则

```python
# 1. 冷却时间
if 距上次交易 < 60秒:
    拒绝交易

# 2. 仓位限制
if 当前仓位 >= 30%:
    拒绝买入

# 3. 止损止盈
if 持仓亏损 >= 2%:
    触发止损卖出
if 持仓盈利 >= 5%:
    触发止盈卖出
```

---

## 3. 使用方法

### 3.1 前置条件

1. **启动OpenD**：确保富途OpenD程序正在运行
2. **模拟账户**：确保富途账户已开通模拟交易功能
3. **训练模型**：确保已有训练好的模型文件

### 3.2 命令行参数

```bash
python 15_paper_trader.py [OPTIONS]

Options:
  --code TEXT           股票代码（默认 HK.00700）
  --model PATH          模型文件路径（默认 models/transformer/model.pt）
  --scaler PATH         标准化器路径（默认自动查找）
  --dry-run             模拟运行，不实际下单
  --confidence FLOAT    最小置信度（默认 0.6）
```

### 3.3 使用示例

```bash
# 模拟运行（推荐先测试）
python scripts/15_paper_trader.py --code HK.00700 --dry-run

# 实际模拟交易
python scripts/15_paper_trader.py --code HK.00700

# 使用LSTM模型
python scripts/15_paper_trader.py --code HK.00700 --model models/lstm/model.pt

# 调整置信度阈值
python scripts/15_paper_trader.py --code HK.00700 --confidence 0.7
```

---

## 4. 运行示例

### 4.1 启动输出

```
============================================================
  OFI论文 - 模拟交易模块
============================================================
  股票代码: HK.00700
  模型路径: models/transformer/model.pt
  运行模式: 实盘模拟

[1] 加载模型...
  模型加载成功: transformer
  参数量: 2,149,123

[2] 加载标准化器...
  标准化器加载成功

[3] 连接富途API...
  模拟账户ID: 281756457115414580
  可用资金: $1,000,000.00
  持仓数量: 0 只
  [OK] 富途API连接成功

[4] 订阅行情...
  订阅成功: HK.00700

[5] 开始交易...
============================================================
  股票: HK.00700
  模式: 实盘模拟
  最小置信度: 60%
============================================================

  等待数据填充缓冲区...
  缓冲区: 10/100
  缓冲区: 20/100
  ...
  缓冲区: 90/100
```

### 4.2 信号输出

```
  14:30:10 | BUY  | 置信度:72.3% | [跌:12.1% 稳:15.6% 涨:72.3%]
  [ORDER] BUY HK.00700 x 100 @ $388.20 (ID: 123456789)

  14:30:20 | HOLD | 置信度:45.2% | [跌:28.3% 稳:45.2% 涨:26.5%]

  14:30:30 | SELL | 置信度:68.5% | [跌:68.5% 稳:18.2% 涨:13.3%]
  [RISK] 冷却中 (45s)

  14:31:20 | SELL | 置信度:65.1% | [跌:65.1% 稳:20.4% 涨:14.5%]
  [ORDER] SELL HK.00700 x 100 @ $387.80 (ID: 123456790)
```

### 4.3 退出统计

```
============================================================
  交易统计
============================================================
  总信号数: 150
  买入信号: 45
  卖出信号: 38
  持有信号: 67
  执行交易: 12
============================================================
  交易记录已保存: trades/history_20260114_143500.json
```

---

## 5. 在富途PC端查看

### 5.1 查看持仓

1. 打开 **富途牛牛** PC客户端
2. 点击 **交易** → **模拟交易**
3. 选择 **持仓** 标签页
4. 可以看到模拟交易的持仓信息

### 5.2 查看订单记录

1. 点击 **交易** → **模拟交易**
2. 选择 **当日订单** 或 **历史订单**
3. 可以看到所有自动下单的记录

### 5.3 查看账户资金

1. 点击 **交易** → **模拟交易**
2. 选择 **资产** 标签页
3. 可以看到可用资金、持仓市值等

---

## 6. 输出文件

### 6.1 交易记录

```json
// trades/history_20260114_143500.json
[
  {
    "time": "2026-01-14T14:30:10",
    "code": "HK.00700",
    "signal": "BUY",
    "qty": 100,
    "price": 388.20,
    "order_id": "123456789"
  },
  {
    "time": "2026-01-14T14:31:20",
    "code": "HK.00700",
    "signal": "SELL",
    "qty": 100,
    "price": 387.80,
    "order_id": "123456790"
  }
]
```

---

## 7. 注意事项

### 7.1 模拟账户说明

- 模拟账户资金为虚拟资金（默认100万港币）
- 交易不涉及真实资金
- 适合策略验证和回测

### 7.2 运行要求

1. **OpenD必须运行**：确保富途OpenD在后台运行
2. **港股交易时间**：
   - 早盘: 09:30 - 12:00
   - 午盘: 13:00 - 16:00
3. **网络稳定**：建议使用有线网络

### 7.3 风险提示

- 模拟交易结果不代表真实交易表现
- 模型预测存在不确定性
- 建议先用`--dry-run`模式测试

---

## 8. 常见问题

### Q1: 连接失败怎么办？

确保OpenD正在运行：
```bash
# 检查OpenD进程
tasklist | findstr OpenD
```

### Q2: 没有模拟账户怎么办？

在富途牛牛PC端：
1. 登录账户
2. 点击 **交易** → **模拟交易**
3. 首次使用会自动开通

### Q3: 缓冲区一直填充不满？

可能原因：
1. 非交易时间（无行情）
2. 股票停牌
3. 网络问题

### Q4: 如何停止交易？

按 `Ctrl+C` 即可安全退出，程序会自动保存交易记录。
