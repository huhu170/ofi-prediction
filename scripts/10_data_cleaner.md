# 数据清洗方案说明
> 可以直接作为论文第三章"数据预处理"部分的补充材料或技术附录使用
> 对应脚本：`10_data_cleaner.py`  
> 版本：v1.0  
> 更新日期：2026-01-14

---

## 1. 概述

本模块负责将原始订单簿（orderbook）和逐笔成交（ticker）数据清洗并聚合为**10秒固定时间窗口**的标准化快照，为后续OFI特征计算和模型训练提供高质量输入数据。

### 1.1 设计目标

| 目标 | 说明 |
|------|------|
| **时间对齐** | 将非等间隔事件流转换为等间隔快照序列 |
| **异常剔除** | 过滤明显错误或异常的数据记录 |
| **缺失处理** | 对短期缺失进行合理填充 |
| **特征预计算** | 计算基础价格和深度特征 |

### 1.2 理论依据

参照 Cont et al.（2014）的实证设置：

> "参照Cont et al.（2014）的实证设置，本研究将时间窗口设定为 **Δt = 10秒**。在每个10秒窗口内，订单流失衡（OFI）被定义为该窗口内所有订单簿事件贡献的累加和。"
> 
> "Cont et al.（2014）的实证结果表明，10秒窗口下OFI对中间价变化的解释力（R²）达到65%，且冲击系数在97%的半小时子样本中保持统计显著性。"

---

## 2. 清洗流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        原始数据层                                │
│  ┌──────────────┐              ┌──────────────┐                 │
│  │  orderbook   │              │    ticker    │                 │
│  │ (订单簿快照)  │              │ (逐笔成交)   │                 │
│  └──────┬───────┘              └──────┬───────┘                 │
└─────────┼─────────────────────────────┼─────────────────────────┘
          │                             │
          ▼                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Step 1: 交易时段过滤                        │
│  • 港股有效时段: 09:35-12:00, 13:00-15:55                       │
│  • 排除开盘后5分钟 (09:30-09:35)                                │
│  • 排除收盘前5分钟 (15:55-16:00)                                │
│  • 排除午间休市 (12:00-13:00)                                   │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Step 2: 时间窗口聚合                        │
│  ┌──────────────────────┐     ┌──────────────────────┐          │
│  │ 订单簿: 取窗口末值    │     │ 逐笔: 累加买卖量     │          │
│  │ (last record)        │     │ (sum by direction)   │          │
│  └──────────┬───────────┘     └──────────┬───────────┘          │
└─────────────┼────────────────────────────┼──────────────────────┘
              │                            │
              ▼                            │
┌─────────────────────────────────────────────────────────────────┐
│                      Step 3: 异常数据过滤与标记                  │
│  过滤（删除）:                                                   │
│  • 零价格 (bid1/ask1 = 0 或 NULL)                               │
│  • 负价差 (ask1 < bid1)                                         │
│  • 价格跳跃 (|Δprice| > 5%)                                     │
│  • 零深度 (bid1_vol 或 ask1_vol = 0)                            │
│  标记（保留）:                                                   │
│  • 极端价差 (spread > 100 bps) → is_extreme_spread=True         │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Step 4: 缺失窗口填充                        │
│  • 短期缺失 (≤30秒): 前向填充 (ffill)                           │
│  • 长期缺失 (>30秒): 标记无效，不跨越                            │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Step 5: 基础特征计算                        │
│  • mid_price = (bid1 + ask1) / 2                                │
│  • spread = ask1 - bid1                                         │
│  • return_pct = Δmid_price / mid_price                          │
│  • depth_imbalance = (bid_depth - ask_depth) / total_depth      │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Step 6: 数据合并与导出                      │
│  订单簿聚合 + 逐笔聚合 → 按时间戳合并 → Parquet / Database       │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 详细处理逻辑

### 3.1 交易时段过滤

港股连续交易时段为09:30-12:00和13:00-16:00。为避免开盘/收盘时段的高波动性和非典型订单流对模型的干扰，本研究排除以下时段的数据：

| 时段 | 排除原因 |
|------|----------|
| 09:30-09:35 | 开盘后5分钟，价格发现尚未完成 |
| 12:00-13:00 | 午间休市，无连续交易 |
| 15:55-16:00 | 收盘前5分钟，机构集中调仓 |

**有效数据时段**：09:35-12:00, 13:00-15:55

**理由**：
- 主流学术研究多排除开盘/收盘各5-15分钟（SEC官方建议排除开盘后5分钟）
- 开盘时段订单流噪声较大，价格发现过程尚未完成
- 收盘时段机构投资者集中调仓，订单流失衡呈非典型特征

### 3.2 时间窗口聚合

#### 订单簿聚合策略

| 字段 | 聚合方法 | 说明 |
|------|---------|------|
| `bid1_price` ~ `bid10_price` | **last** | 取窗口内最后一条记录 |
| `bid1_vol` ~ `bid10_vol` | **last** | 代表窗口结束时的订单簿状态 |
| `ask1_price` ~ `ask10_price` | **last** | 同上 |
| `ask1_vol` ~ `ask10_vol` | **last** | 同上 |

**理由**：订单簿是状态量，取窗口末值能反映该时间点的即时供需状态。

#### 逐笔成交聚合策略

| 字段 | 聚合方法 | 说明 |
|------|---------|------|
| `buy_volume` | **sum** | 窗口内所有买方成交量累加 |
| `sell_volume` | **sum** | 窗口内所有卖方成交量累加 |
| `trade_count` | **count** | 窗口内成交笔数 |
| `avg_price` | **mean** | 窗口内成交均价 |
| `last_price` | **last** | 窗口内最后成交价 |

**理由**：成交是流量事件，需要累加统计窗口内的交易活动。

### 3.3 异常数据过滤与标记

#### 过滤类型（直接删除）

| 异常类型 | 判定条件 | 处理方式 | 参考依据 |
|---------|---------|---------|---------|
| **零价格** | `bid1_price ≤ 0` 或 `ask1_price ≤ 0` | 剔除 | 数据缺失或传输错误 |
| **负价差** | `ask1_price < bid1_price` | 剔除 | 违反基本市场规则 |
| **价格跳跃** | `|Δmid_price| > 5%` | 剔除 | 可能为停牌/复牌或错误 |
| **零深度** | `bid1_vol = 0` 或 `ask1_vol = 0` | 剔除 | 无法计算有效OFI |

#### 标记类型（保留但添加标记字段）

| 异常类型 | 判定条件 | 处理方式 | 理由 |
|---------|---------|---------|------|
| **极端价差** | `spread > mid_price × 1%` (100 bps) | 添加 `is_extreme_spread=True` | 大价差本身是订单流不平衡的重要信号，可能包含有价值的预测信息，不应直接过滤 |

**设计说明**：
- 极端价差（100基点=1%）往往出现在流动性紧张时刻，恰恰是订单流不平衡最显著的时候
- 过滤这些数据可能丢失极端行情下的重要训练样本
- 通过标记字段，后续特征工程/模型训练阶段可以灵活处理：
  - 作为独立特征使用
  - 进行分组分析（含/不含极端价差）
  - 在稳健性检验中对比不同样本集的效果

### 3.4 缺失窗口填充

```python
# 缺失判定逻辑
if 连续缺失窗口数 <= 3:  # ≤30秒
    # 使用前向填充（假设市场状态不变）
    df[cols].ffill()
else:  # >30秒
    # 标记为无效，后续分析不跨越此段
    mark_as_invalid()
```

**理由**：
- 短期缺失（≤30秒）通常因API推送延迟或网络抖动，市场状态变化有限
- 长期缺失可能遗漏重要市场事件（如熔断、暂停交易），不宜简单填充

---

## 4. 输出数据结构

### 4.1 输出列说明

| 类别 | 列名 | 类型 | 说明 |
|------|------|------|------|
| **索引** | `ts` | datetime | 10秒窗口时间戳 |
| **索引** | `code` | string | 股票代码 |
| **订单簿** | `bid1_price` ~ `bid10_price` | float | 买盘1-10档价格 |
| **订单簿** | `bid1_vol` ~ `bid10_vol` | int | 买盘1-10档数量 |
| **订单簿** | `ask1_price` ~ `ask10_price` | float | 卖盘1-10档价格 |
| **订单簿** | `ask1_vol` ~ `ask10_vol` | int | 卖盘1-10档数量 |
| **价格特征** | `mid_price` | float | 中间价 |
| **价格特征** | `spread` | float | 买卖价差 |
| **价格特征** | `spread_bps` | float | 价差（基点） |
| **价格特征** | `is_extreme_spread` | bool | 极端价差标记（>100bps为True） |
| **价格特征** | `return_pct` | float | 收益率（%） |
| **深度特征** | `bid_depth_5` / `bid_depth_10` | int | 买盘5/10档总量 |
| **深度特征** | `ask_depth_5` / `ask_depth_10` | int | 卖盘5/10档总量 |
| **深度特征** | `depth_imbalance_5` / `depth_imbalance_10` | float | 深度不平衡度 |
| **成交特征** | `buy_volume` | int | 窗口内买方成交量 |
| **成交特征** | `sell_volume` | int | 窗口内卖方成交量 |
| **成交特征** | `trade_count` | int | 窗口内成交笔数 |
| **成交特征** | `trade_imbalance` | float | 成交不平衡度 |

### 4.2 输出文件格式

```
data/processed/
└── {股票代码}/
    ├── cleaned_20260114.parquet
    ├── cleaned_20260115.parquet
    └── ...
```

---

## 5. 参数配置

### 5.1 核心参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `WINDOW_SECONDS` | 10 | 聚合窗口大小（秒） |
| `MAX_SPREAD_BPS` | 100 | 极端价差标记阈值（基点），超过此值标记 is_extreme_spread=True |
| `MAX_PRICE_JUMP_PCT` | 5.0 | 最大允许价格跳跃（%），超过则过滤 |
| `MIN_DEPTH` | 0 | 最小深度阈值 |

### 5.2 命令行参数

```bash
python 10_data_cleaner.py [OPTIONS]

Options:
  --code TEXT        股票代码，如 HK.00700
  --start TEXT       开始日期 YYYY-MM-DD
  --end TEXT         结束日期 YYYY-MM-DD
  --days INTEGER     处理最近N天（默认20）
  --export-db        同时保存到数据库
  --no-parquet       不导出Parquet文件
```

---

## 6. 使用示例

### 6.1 清洗单只股票

```bash
# 清洗腾讯控股最近20天数据
python scripts/10_data_cleaner.py --code HK.00700 --days 20
```

### 6.2 清洗指定日期范围

```bash
# 清洗2026年1月所有数据
python scripts/10_data_cleaner.py --start 2026-01-01 --end 2026-01-31
```

### 6.3 同时保存到数据库

```bash
python scripts/10_data_cleaner.py --code HK.00700 --export-db
```

---

## 7. 数据压缩效果

以2026-01-14 HK.00700测试数据为例：

| 指标 | 原始数据 | 清洗后 | 压缩比 |
|------|---------|--------|--------|
| 订单簿记录 | 38,843 条 | - | - |
| 逐笔记录 | 12,490 条 | - | - |
| 聚合窗口数 | - | 1,190 个 | **32.6:1** |
| 缺失填充 | - | +41 个 | - |
| 最终有效窗口 | - | **1,231 个** | - |

**数据量估算**（按论文设定）：
- 每日交易时段：约6.5小时 = 23,400秒
- 理论窗口数：23,400 / 10 = **2,340个/股/日**
- 20天训练数据：2,340 × 20 = **46,800个窗口**

---

## 8. 与论文对齐

| 论文设定 | 本实现 | 对齐状态 |
|---------|--------|---------|
| 时间窗口 Δt = 10秒 | `WINDOW_SECONDS = 10` | ✅ |
| 排除开盘/收盘5分钟 | 有效时段 09:35-12:00, 13:00-15:55 | ✅ |
| 输入序列 T = 100步 | 后续特征计算模块处理 | ⏳ |
| 预测步长 k ∈ {20, 50, 100} | 后续标签生成模块处理 | ⏳ |
| 短期缺失前向填充 | `ffill()` for ≤3 windows | ✅ |
| 长期缺失不跨越 | 标记为无效 | ✅ |

---

## 9. 后续步骤

本模块输出的清洗数据将用于：

1. **`11_feature_calculator.py`** - 计算OFI系列特征（OFI-L1、OFI-L5、Smart-OFI）
2. **`12_label_generator.py`** - 生成预测标签（k=20/50/100步后的价格方向）
3. **`13_dataset_builder.py`** - 构建滑动窗口训练集
4. **导出最终Parquet** - 供模型训练使用

---

## 10. 注意事项

1. **时区处理**：数据库中时间戳为UTC，输出保持UTC格式
2. **空窗口**：若某窗口无成交，`buy_volume`/`sell_volume`/`trade_count` 填充为0
3. **首条数据**：`return_pct` 的第一条为NaN（无前值可比较）
4. **深度不平衡**：分母加 `1e-8` 防止除零
5. **Parquet引擎**：使用 `pyarrow`，确保已安装
