# 特征计算方案说明

> 可以直接作为论文第三章"特征工程"部分的补充材料或技术附录使用
> 对应脚本：`11_feature_calculator.py`  
> 版本：v2.0  
> 更新日期：2026-01-16

---

## 1. 概述

本模块基于清洗后的订单簿数据（10秒窗口快照），计算OFI系列特征和预测标签，为后续模型训练提供标准化特征输入。

### 1.1 特征体系（与论文对齐）

```
┌─────────────────────────────────────────────────────────────────┐
│                       特征层级体系                               │
├─────────────────────────────────────────────────────────────────┤
│  Level 1: 基础OFI (OFI-L1)                                      │
│           → 单档订单流不平衡                                     │
│                                                                 │
│  Level 2: 多档OFI (OFI-L5, OFI-L10)                             │
│           → 深度衰减加权的多档订单流                             │
│                                                                 │
│  Level 3: 分档OFI (ofi_level_1..10)                             │
│           → 各档独立OFI，用于SHAP分析                            │
│                                                                 │
│  Level 4: Smart-OFI                                             │
│           → 撤单率(1-CR_k)修正的有效OFI（论文公式2.2-3）         │
│                                                                 │
│  Level 5: 滚动统计特征                                          │
│           → MA, STD, Z-score                                    │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 理论依据

| 特征 | 理论来源 | 核心思想 |
|------|---------|---------|
| 基础OFI | Cont et al. (2014) | 买卖盘订单流净差值 |
| 多档OFI | Zhang et al. (2019) | 深层流动性的价格发现贡献 |
| 分档OFI | 本文扩展 | 各档独立特征，支持SHAP归因分析 |
| Smart-OFI | 论文公式(2.2-3) | 撤单率修正，过滤虚假流动性 |

---

## 2. 特征计算详解

### 2.1 基础OFI (OFI-L1)

**定义**：第1档买卖盘订单量变化的净差值

```
OFI_L1(t) = Δbid1_vol(t) - Δask1_vol(t)
         = [bid1_vol(t) - bid1_vol(t-1)] - [ask1_vol(t) - ask1_vol(t-1)]
```

**含义**：
- `OFI_L1 > 0`：买盘增量 > 卖盘增量 → 买方压力
- `OFI_L1 < 0`：卖盘增量 > 买盘增量 → 卖方压力
- `OFI_L1 = 0`：供需平衡

**示例**：
| 时刻 | bid1_vol | ask1_vol | Δbid1 | Δask1 | OFI_L1 |
|------|----------|----------|-------|-------|--------|
| t-1 | 10,000 | 8,000 | - | - | - |
| t | 12,000 | 7,500 | +2,000 | -500 | **+2,500** |
| t+1 | 11,000 | 9,000 | -1,000 | +1,500 | **-2,500** |

---

### 2.2 多档加权OFI (OFI-L5, OFI-L10)

**定义**：对多档OFI进行深度加权

```
OFI_multi(t) = Σ[w_k × OFI_k(t)], k = 1 to K

其中：
- OFI_k(t) = Δbid_k_vol(t) - Δask_k_vol(t)
- w_k 为深度加权系数（支持三种方案）
```

**深度加权方案对比**（可通过 `--weight-method` 参数切换）：

| 方案 | 公式 | 5档权重分布 | 适用场景 |
|------|------|------------|----------|
| `exponential` (默认) | w_k = exp(-α×k) / Σexp(-α×i) | [0.47, 0.29, 0.15, 0.07, 0.03] | 大盘高流动性股票 |
| `linear` | w_k = (K-k+1) / Σi | [0.33, 0.27, 0.20, 0.13, 0.07] | 中等流动性股票 |
| `equal` | w_k = 1/K | [0.20, 0.20, 0.20, 0.20, 0.20] | 基准对比 |

**指数衰减参数**：α = 0.5（衰减系数，仅用于exponential方案）

**权重分布（α=0.5, K=5）**：

| 档位 | 原始权重 | 归一化权重 | 累计权重 |
|------|---------|-----------|---------|
| 1档 | 0.607 | **39.4%** | 39.4% |
| 2档 | 0.368 | **23.9%** | 63.3% |
| 3档 | 0.223 | **14.5%** | 77.8% |
| 4档 | 0.135 | **8.8%** | 86.6% |
| 5档 | 0.082 | **5.3%** | 91.9% |

**设计思想**：
- 第1档权重最高（最接近成交）
- 深层档位权重递减（边际信息贡献递减）
- 通过加权聚合保留深度结构信息

---

### 2.3 分档OFI（ofi_level_1..10）

**新增特征**：各档位独立计算的OFI，用于SHAP归因分析

**定义**：
```
ofi_level_k(t) = Δbid_k_vol(t) - Δask_k_vol(t)
```

**用途**：
1. **SHAP分析**：评估各档位对预测的独立贡献
2. **深度结构洞察**：观察不同深度对价格的影响
3. **特征选择**：识别冗余档位，优化计算效率

**示例**：
| 时刻 | ofi_level_1 | ofi_level_2 | ofi_level_3 | ... | ofi_level_10 |
|------|-------------|-------------|-------------|-----|--------------|
| t | +2,500 | +1,200 | -500 | ... | +100 |
| t+1 | -1,500 | +800 | +200 | ... | -50 |

---

### 2.4 Smart-OFI（撤单率修正的有效OFI）

**问题**：传统OFI无法区分"真实挂单"与"虚假流动性"（如高频交易的幌骗行为）

**论文公式(2.2-3)**：

```
OFI_t^{effective} = Σ(k=1 to K) (1 - CR_k) × OFI_t^(k)

其中：
- CR_k = 第k档的撤单率（Cancellation Rate）
- (1 - CR_k) = 承诺权重，撤单率越高权重越低
```

**核心挑战**：API不直接提供撤单数据，且**挂单量减少 ≠ 撤单**（可能是成交消耗）

**混合估计方案**（结合挂单量 + 订单数信息）：

```
挂单量减少的原因分解：
Δvol < 0 = 撤单 + 成交消耗

利用订单数（orders）区分：
- 量减+笔数减：可能是撤单或成交 → CR = |Δvol|/prev_vol × 0.5
- 量减+笔数不变/增：主要是成交消耗 → CR = |Δvol|/prev_vol × 0.2
- 量增+笔数减：大单进入（高质量）→ CR = -0.3（放大信号）
- 量增+笔数增：正常挂单 → CR = 0
```

**撤单率估计逻辑**：

| 挂单量变化 | 订单数变化 | 解读 | CR估计 | 承诺权重(1-CR) |
|-----------|-----------|------|--------|----------------|
| Δvol < 0 | Δorders < 0 | 撤单或成交 | 0.5 × raw | **0.5-1.0** |
| Δvol < 0 | Δorders ≥ 0 | 主要是成交消耗 | 0.2 × raw | **0.8-1.0** |
| Δvol > 0 | Δorders < 0 | **大单进入** | **-0.3** | **1.3（放大）** |
| Δvol > 0 | Δorders ≥ 0 | 正常挂单 | 0 | **1.0** |

> 注：raw = |Δvol| / prev_vol

**示例**：

| 档位 | prev_vol | curr_vol | Δvol | prev_orders | curr_orders | Δorders | 情况 | CR | 权重(1-CR) |
|------|----------|----------|------|-------------|-------------|---------|------|-----|-----------|
| 1档 | 10,000 | 8,000 | -2,000 | 50 | 45 | -5 | 撤单或成交 | 0.10 | **0.90** |
| 2档 | 5,000 | 4,000 | -1,000 | 30 | 35 | +5 | 成交消耗 | 0.04 | **0.96** |
| 3档 | 3,000 | 5,000 | +2,000 | 40 | 35 | -5 | **大单进入** | -0.30 | **1.30** |

**核心逻辑**：
- 利用订单数变化区分"撤单"与"成交消耗"
- 大单进入（量增+笔数减）给予超额权重（1.3），放大高质量信号
- 成交消耗（量减+笔数增）给予较低惩罚，避免误判

---

### 2.5 滚动统计特征

**计算公式**：
```python
window = 10  # 10个时间步 = 100秒

# 移动平均
ofi_ma_10 = rolling_mean(ofi_l1, window=10)

# 移动标准差
ofi_std_10 = rolling_std(ofi_l1, window=10)

# Z-score标准化
ofi_zscore = (ofi_l1 - ofi_ma_10) / (ofi_std_10 + ε)
```

**Z-score的作用**：
- 消除量纲差异
- 识别异常值（|Z| > 2表示显著偏离）
- 便于跨股票/跨时段比较

---

## 3. 预测标签生成

### 3.1 波动率自适应阈值

**问题**：固定阈值无法适应不同市场状态

**解决方案**：阈值随历史波动率动态调整

```
threshold(t) = α × rolling_std(return, window=100)

其中：
- α = 0.3 （阈值系数）
- window = 100 （约16.7分钟）
```

**标签生成规则**：
```python
if future_return > threshold:
    label = 1   # 上涨
elif future_return < -threshold:
    label = -1  # 下跌
else:
    label = 0   # 平稳
```

### 3.2 阈值系数的经济含义

| α值 | 含义 | 适用场景 |
|-----|------|---------|
| 0.2 | 较敏感 | 捕捉微弱趋势 |
| 0.3 | 中等（推荐）| 平衡信噪比 |
| 0.5 | 较保守 | 只识别显著变动 |

**α=0.3的理论依据**：
- 正态分布中，约68%的样本落在±1σ内
- α=0.3意味着只有偏离超过0.3个标准差才算"显著"
- 在标准正态分布下，这对应约23.6%的样本被判为上涨/下跌

### 3.3 阈值敏感性分析（论文4.2节）

**实验设计**：

| 参数配置 | 上涨比例 | 平稳比例 | 下跌比例 | 预测准确率 |
|---------|---------|---------|---------|-----------|
| α=0.2 | [待填] | [待填] | [待填] | [待填] |
| α=0.3 | 30.4% | 37.7% | 31.9% | [待填] |
| α=0.5 | [待填] | [待填] | [待填] | [待填] |

**分析目标**：
1. 找到最优α值（最大化预测准确率）
2. 验证结论对α值选择的稳健性
3. 为不同应用场景提供参数指导

---

## 4. 输出特征表

### 4.1 完整特征列表（47列）

| 类别 | 字段名 | 类型 | 说明 |
|------|--------|------|------|
| **索引** | `ts` | datetime | 时间戳 |
| **索引** | `code` | string | 股票代码 |
| **价格** | `mid_price` | float | 中间价 |
| **价格** | `spread` | float | 买卖价差 |
| **价格** | `spread_bps` | float | 价差（基点） |
| **价格** | `return_pct` | float | 收益率（%） |
| **OFI聚合** | `ofi_l1` | float | 单档OFI |
| **OFI聚合** | `ofi_l5` | float | 5档加权OFI（指数衰减） |
| **OFI聚合** | `ofi_l10` | float | 10档加权OFI |
| **OFI聚合** | `smart_ofi` | float | 撤单率修正OFI（公式2.2-3） |
| **分档OFI** | `ofi_level_1` | float | 第1档独立OFI |
| **分档OFI** | `ofi_level_2` | float | 第2档独立OFI |
| **分档OFI** | `ofi_level_3` | float | 第3档独立OFI |
| **分档OFI** | `ofi_level_4` | float | 第4档独立OFI |
| **分档OFI** | `ofi_level_5` | float | 第5档独立OFI |
| **分档OFI** | `ofi_level_6` | float | 第6档独立OFI |
| **分档OFI** | `ofi_level_7` | float | 第7档独立OFI |
| **分档OFI** | `ofi_level_8` | float | 第8档独立OFI |
| **分档OFI** | `ofi_level_9` | float | 第9档独立OFI |
| **分档OFI** | `ofi_level_10` | float | 第10档独立OFI |
| **滚动** | `ofi_ma_10` | float | OFI 10期均值 |
| **滚动** | `ofi_std_10` | float | OFI 10期标准差 |
| **滚动** | `ofi_zscore` | float | OFI Z-score |
| **滚动** | `smart_ofi_ma_10` | float | Smart-OFI均值 |
| **滚动** | `smart_ofi_std_10` | float | Smart-OFI标准差 |
| **滚动** | `smart_ofi_zscore` | float | Smart-OFI Z-score |
| **滚动** | `return_ma_10` | float | 收益率均值 |
| **滚动** | `return_std_10` | float | 收益率标准差 |
| **深度** | `bid_depth_5/10` | int | 买盘深度 |
| **深度** | `ask_depth_5/10` | int | 卖盘深度 |
| **深度** | `depth_imbalance_5/10` | float | 深度不平衡 |
| **成交** | `buy_volume` | int | 买方成交量 |
| **成交** | `sell_volume` | int | 卖方成交量 |
| **成交** | `trade_count` | int | 成交笔数 |
| **成交** | `trade_imbalance` | float | 成交不平衡 |
| **协方差** | `cov_stock_index` | float | 个股-指数协方差 |
| **协方差** | `corr_stock_index` | float | 个股-指数相关系数 |
| **标签** | `threshold` | float | 自适应阈值 |
| **标签** | `future_return_20/50/100` | float | 未来收益率 |
| **标签** | `label_20/50/100` | int | 预测标签(-1/0/1) |

### 4.2 输出文件格式

```
data/processed/
└── HK_00700/
    ├── cleaned_20260114.parquet    ← 清洗后数据（输入）
    └── features_20260114.parquet   ← 特征数据（输出）
```

---

## 5. 使用方法

### 5.1 命令行参数

```bash
python 11_feature_calculator.py [OPTIONS]

Options:
  --input PATH         指定输入Parquet文件
  --code TEXT          股票代码（如 HK.00700）
  --days INTEGER       处理最近N天（默认20）
  --no-covariance      不计算动态协方差
  --index TEXT         指数代码（默认 HK.800000）
  --alpha FLOAT        标签阈值系数（默认 0.3）
  --weight-method TEXT 深度加权方案: exponential | linear | equal（默认 exponential）
```

### 5.2 使用示例

```bash
# 处理单个文件
python scripts/11_feature_calculator.py --input data/processed/HK_00700/cleaned_20260114.parquet

# 处理指定股票最近20天
python scripts/11_feature_calculator.py --code HK.00700 --days 20

# 使用不同阈值系数进行敏感性分析
python scripts/11_feature_calculator.py --code HK.00700 --alpha 0.2
python scripts/11_feature_calculator.py --code HK.00700 --alpha 0.5

# 深度加权方案对比实验（消融实验）
python scripts/11_feature_calculator.py --code HK.00700 --weight-method exponential  # 指数衰减（默认）
python scripts/11_feature_calculator.py --code HK.00700 --weight-method linear       # 线性衰减
python scripts/11_feature_calculator.py --code HK.00700 --weight-method equal        # 等权重
```

---

## 6. 处理流程图

```
cleaned_*.parquet
       │
       ▼
┌──────────────────────────────────┐
│  Step 1: 计算订单簿变化量         │
│  Δbid1..10_vol, Δask1..10_vol    │
└──────────────┬───────────────────┘
               │
               ▼
┌──────────────────────────────────┐
│  Step 2: 计算OFI系列特征          │
│  ofi_l1, ofi_l5, ofi_l10         │
│  ofi_level_1..10（各档独立）      │
│  smart_ofi（撤单率修正）          │
└──────────────┬───────────────────┘
               │
               ▼
┌──────────────────────────────────┐
│  Step 3: 计算滚动统计特征         │
│  ma_10, std_10, zscore           │
└──────────────┬───────────────────┘
               │
               ▼
┌──────────────────────────────────┐
│  Step 4: 生成预测标签             │
│  threshold = α × σ               │
│  label = sign(future_return)     │
└──────────────┬───────────────────┘
               │
               ▼
┌──────────────────────────────────┐
│  Step 5: 计算动态协方差（可选）    │
│  cov(stock, index)               │
└──────────────┬───────────────────┘
               │
               ▼
       features_*.parquet
```

---

## 7. 实测结果示例

以 HK.00700 (腾讯控股) 2026-01-14 数据为例：

| 指标 | 数值 |
|------|------|
| 输入记录 | 1,231 |
| 输出记录 | 1,230 |
| 特征列数 | 37 |

**OFI特征统计**：

| 特征 | 均值 | 标准差 | 偏度 |
|------|------|--------|------|
| ofi_l1 | -72.1 | 32,967 | -0.09 |
| ofi_l5 | -0.6 | 15,319 | 0.52 |
| smart_ofi | 102.4 | 6,864 | 0.74 |

**标签分布（α=0.3, k=20）**：

| 类别 | 比例 |
|------|------|
| 上涨(1) | 30.4% |
| 平稳(0) | 37.7% |
| 下跌(-1) | 31.9% |

---

## 8. 与论文对齐

| 论文设定 | 本实现 | 对齐状态 |
|---------|--------|---------|
| 深度衰减加权（公式2.2-1） | α=0.5指数衰减 | ✅ |
| 撤单率修正（公式2.2-3） | **混合估计：挂单量+订单数** | ✅ **增强实现** |
| 分档OFI | ofi_level_1..10 | ✅ **新增** |
| 滚动窗口 W=100 | window=10 (OFI), 100 (协方差) | ✅ |
| 预测步长 k∈{20,50,100} | PREDICTION_HORIZONS=[20,50,100] | ✅ |
| 波动率自适应阈值（公式3.1-3） | threshold = α × σ | ✅ |
| Z-score归一化（公式3.1-2） | (x - μ) / σ，仅训练集fit | ✅ |
| 动态协方差 | rolling_cov(stock, index) | ✅ |

> **撤单率增强说明**：论文公式(2.2-3)定义CR=撤单量/挂单量，但API不提供撤单数据。
> 本实现结合订单数（orders）信息区分"撤单"与"成交消耗"，比纯粹基于挂单量减少更准确。

---

## 9. 后续步骤

本模块输出的特征数据将用于：

1. **`12_dataset_builder.py`** - 构建滑动窗口训练集（T=100步输入）
2. **`13_model_trainer.py`** - 模型训练（Transformer/CNN-LSTM）
3. **`14_backtest.py`** - 策略回测与经济价值评估

---

## 10. 未来扩展方向

### 10.1 市场状态检测（HMM/聚类）

**背景**：OFI信号在不同市场状态下的含义可能不同。例如：
- 平稳期：OFI的预测效果稳定
- 波动期：OFI信号可能被噪声干扰

**方法**：使用隐马尔可夫模型（HMM）或K-Means聚类检测市场状态

```python
# HMM市场状态检测示例
from hmmlearn.hmm import GaussianHMM

features = ['return_std_10', 'spread_bps', 'depth_imbalance_5']
hmm_model = GaussianHMM(n_components=3)  # 3个状态：平稳、波动、极端
hmm_model.fit(df[features])
df['market_regime'] = hmm_model.predict(df[features])
# 0=平稳期, 1=波动期, 2=极端波动期
```

**用途**：
1. **条件化建模**：为不同市场状态训练不同模型或使用不同参数
2. **风控预警**：极端状态触发风控机制
3. **特征权重调整**：波动期降低OFI权重，提高价差权重

### 10.2 OFI市值归一化

**最新研究建议**：用市值（Market Cap）替代成交量来归一化OFI信号，可提升信号质量1.3-2倍。

```python
# 市值归一化示例
ofi_normalized = ofi / market_cap  # 而非 ofi / volume
```

**当前状态**：论文中未明确要求，作为可选优化保留。

---

## 11. 注意事项

1. **数据对齐**：如果输入数据缺少6-10档，自动填充为0
2. **NaN处理**：第一条记录无法计算diff，自动剔除
3. **阈值单位**：threshold与future_return均为小数形式（0.001表示0.1%）
4. **协方差计算**：需要指数K线数据，如无则跳过
5. **标签截断**：最后k条记录无法计算future_return，标签为NaN
6. **撤单率估计**：由于API不直接提供撤单数据，采用挂单量减少来近似
