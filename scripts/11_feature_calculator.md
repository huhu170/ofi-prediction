# 特征计算方案说明

> 可以直接作为论文第三章"特征工程"部分的补充材料或技术附录使用
> 对应脚本：`11_feature_calculator.py`  
> 版本：v1.0  
> 更新日期：2026-01-14

---

## 1. 概述

本模块基于清洗后的订单簿数据（10秒窗口快照），计算OFI系列特征和预测标签，为后续模型训练提供标准化特征输入。

### 1.1 特征体系（与论文对齐）

```
┌─────────────────────────────────────────────────────────────────┐
│                       特征层级体系                               │
├─────────────────────────────────────────────────────────────────┤
│  Level 1: 基础OFI (OFI-L1)                                      │
│           → 单档订单流不平衡                                     │
│                                                                 │
│  Level 2: 多档OFI (OFI-L5, OFI-L10)                             │
│           → 深度衰减加权的多档订单流                             │
│                                                                 │
│  Level 3: Smart-OFI                                             │
│           → 承诺强度修正（识别"聪明钱"）                         │
│                                                                 │
│  Level 4: 滚动统计特征                                          │
│           → MA, STD, Z-score                                    │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 理论依据

| 特征 | 理论来源 | 核心思想 |
|------|---------|---------|
| 基础OFI | Cont et al. (2014) | 买卖盘订单流净差值 |
| 多档OFI | Zhang et al. (2019) | 深层流动性的价格发现贡献 |
| Smart-OFI | Goldstein et al. (2016) | 过滤虚假流动性，识别真实交易意图 |

---

## 2. 特征计算详解

### 2.1 基础OFI (OFI-L1)

**定义**：第1档买卖盘订单量变化的净差值

```
OFI_L1(t) = Δbid1_vol(t) - Δask1_vol(t)
         = [bid1_vol(t) - bid1_vol(t-1)] - [ask1_vol(t) - ask1_vol(t-1)]
```

**含义**：
- `OFI_L1 > 0`：买盘增量 > 卖盘增量 → 买方压力
- `OFI_L1 < 0`：卖盘增量 > 买盘增量 → 卖方压力
- `OFI_L1 = 0`：供需平衡

**示例**：
| 时刻 | bid1_vol | ask1_vol | Δbid1 | Δask1 | OFI_L1 |
|------|----------|----------|-------|-------|--------|
| t-1 | 10,000 | 8,000 | - | - | - |
| t | 12,000 | 7,500 | +2,000 | -500 | **+2,500** |
| t+1 | 11,000 | 9,000 | -1,000 | +1,500 | **-2,500** |

---

### 2.2 多档加权OFI (OFI-L5, OFI-L10)

**定义**：对多档OFI进行深度衰减加权

```
OFI_multi(t) = Σ[w_k × OFI_k(t)], k = 1 to K

其中：
- OFI_k(t) = Δbid_k_vol(t) - Δask_k_vol(t)
- w_k = exp(-α × k) / Σexp(-α × i)  （归一化指数衰减）
- α = 0.5 （衰减系数）
```

**权重分布（α=0.5, K=5）**：

| 档位 | 原始权重 | 归一化权重 | 累计权重 |
|------|---------|-----------|---------|
| 1档 | 0.607 | **39.4%** | 39.4% |
| 2档 | 0.368 | **23.9%** | 63.3% |
| 3档 | 0.223 | **14.5%** | 77.8% |
| 4档 | 0.135 | **8.8%** | 86.6% |
| 5档 | 0.082 | **5.3%** | 91.9% |

**设计思想**：
- 第1档权重最高（最接近成交）
- 深层档位权重递减（边际信息贡献递减）
- 通过加权聚合保留深度结构信息

---

### 2.3 Smart-OFI（承诺强度修正）

**问题**：传统OFI无法区分"真实挂单"与"虚假流动性"（如高频交易的幌骗行为）

**解决方案**：基于订单数变化推断"承诺强度"

```
Smart-OFI(t) = commitment_weight(t) × OFI_L5(t)
```

**承诺强度权重计算**：

| 挂单量变化 | 订单数变化 | 解读 | 权重 |
|-----------|-----------|------|------|
| Δvol > 0 | Δorders < 0 | 大单进入，小单被清 | **1.5** |
| Δvol > 0 | Δorders ≥ 0 | 正常挂单 | **1.0** |
| Δvol < 0 | - | 可能是撤单 | **0.5** |
| Δvol = 0 | Δorders ≠ 0 | 订单重组 | **0.8** |

**核心逻辑**：
- "大单进入"（量增+笔数减）通常代表机构投资者的真实意图 → 高权重
- 频繁小单撤入可能是噪声或操纵 → 低权重

---

### 2.4 滚动统计特征

**计算公式**：
```python
window = 10  # 10个时间步 = 100秒

# 移动平均
ofi_ma_10 = rolling_mean(ofi_l1, window=10)

# 移动标准差
ofi_std_10 = rolling_std(ofi_l1, window=10)

# Z-score标准化
ofi_zscore = (ofi_l1 - ofi_ma_10) / (ofi_std_10 + ε)
```

**Z-score的作用**：
- 消除量纲差异
- 识别异常值（|Z| > 2表示显著偏离）
- 便于跨股票/跨时段比较

---

## 3. 预测标签生成

### 3.1 波动率自适应阈值

**问题**：固定阈值无法适应不同市场状态

**解决方案**：阈值随历史波动率动态调整

```
threshold(t) = α × rolling_std(return, window=100)

其中：
- α = 0.3 （阈值系数）
- window = 100 （约16.7分钟）
```

**标签生成规则**：
```python
if future_return > threshold:
    label = 1   # 上涨
elif future_return < -threshold:
    label = -1  # 下跌
else:
    label = 0   # 平稳
```

### 3.2 阈值系数的经济含义

| α值 | 含义 | 适用场景 |
|-----|------|---------|
| 0.2 | 较敏感 | 捕捉微弱趋势 |
| 0.3 | 中等（推荐）| 平衡信噪比 |
| 0.5 | 较保守 | 只识别显著变动 |

**α=0.3的理论依据**：
- 正态分布中，约68%的样本落在±1σ内
- α=0.3意味着只有偏离超过0.3个标准差才算"显著"
- 在标准正态分布下，这对应约23.6%的样本被判为上涨/下跌

### 3.3 阈值敏感性分析（论文4.2节）

**实验设计**：

| 参数配置 | 上涨比例 | 平稳比例 | 下跌比例 | 预测准确率 |
|---------|---------|---------|---------|-----------|
| α=0.2 | [待填] | [待填] | [待填] | [待填] |
| α=0.3 | 30.4% | 37.7% | 31.9% | [待填] |
| α=0.5 | [待填] | [待填] | [待填] | [待填] |

**分析目标**：
1. 找到最优α值（最大化预测准确率）
2. 验证结论对α值选择的稳健性
3. 为不同应用场景提供参数指导

---

## 4. 输出特征表

### 4.1 完整特征列表（37列）

| 类别 | 字段名 | 类型 | 说明 |
|------|--------|------|------|
| **索引** | `ts` | datetime | 时间戳 |
| **索引** | `code` | string | 股票代码 |
| **价格** | `mid_price` | float | 中间价 |
| **价格** | `spread` | float | 买卖价差 |
| **价格** | `spread_bps` | float | 价差（基点） |
| **价格** | `return_pct` | float | 收益率（%） |
| **OFI** | `ofi_l1` | float | 单档OFI |
| **OFI** | `ofi_l5` | float | 5档加权OFI |
| **OFI** | `ofi_l10` | float | 10档加权OFI |
| **OFI** | `smart_ofi` | float | 承诺强度修正OFI |
| **滚动** | `ofi_ma_10` | float | OFI 10期均值 |
| **滚动** | `ofi_std_10` | float | OFI 10期标准差 |
| **滚动** | `ofi_zscore` | float | OFI Z-score |
| **滚动** | `smart_ofi_ma_10` | float | Smart-OFI均值 |
| **滚动** | `smart_ofi_std_10` | float | Smart-OFI标准差 |
| **滚动** | `smart_ofi_zscore` | float | Smart-OFI Z-score |
| **滚动** | `return_ma_10` | float | 收益率均值 |
| **滚动** | `return_std_10` | float | 收益率标准差 |
| **深度** | `bid_depth_5/10` | int | 买盘深度 |
| **深度** | `ask_depth_5/10` | int | 卖盘深度 |
| **深度** | `depth_imbalance_5/10` | float | 深度不平衡 |
| **成交** | `buy_volume` | int | 买方成交量 |
| **成交** | `sell_volume` | int | 卖方成交量 |
| **成交** | `trade_count` | int | 成交笔数 |
| **成交** | `trade_imbalance` | float | 成交不平衡 |
| **协方差** | `cov_stock_index` | float | 个股-指数协方差 |
| **协方差** | `corr_stock_index` | float | 个股-指数相关系数 |
| **标签** | `threshold` | float | 自适应阈值 |
| **标签** | `future_return_20/50/100` | float | 未来收益率 |
| **标签** | `label_20/50/100` | int | 预测标签(-1/0/1) |

### 4.2 输出文件格式

```
data/processed/
└── HK_00700/
    ├── cleaned_20260114.parquet    ← 清洗后数据（输入）
    └── features_20260114.parquet   ← 特征数据（输出）
```

---

## 5. 使用方法

### 5.1 命令行参数

```bash
python 11_feature_calculator.py [OPTIONS]

Options:
  --input PATH         指定输入Parquet文件
  --code TEXT          股票代码（如 HK.00700）
  --days INTEGER       处理最近N天（默认20）
  --no-covariance      不计算动态协方差
  --index TEXT         指数代码（默认 HK.800000）
  --alpha FLOAT        标签阈值系数（默认 0.3）
```

### 5.2 使用示例

```bash
# 处理单个文件
python scripts/11_feature_calculator.py --input data/processed/HK_00700/cleaned_20260114.parquet

# 处理指定股票最近20天
python scripts/11_feature_calculator.py --code HK.00700 --days 20

# 使用不同阈值系数进行敏感性分析
python scripts/11_feature_calculator.py --code HK.00700 --alpha 0.2
python scripts/11_feature_calculator.py --code HK.00700 --alpha 0.5
```

---

## 6. 处理流程图

```
cleaned_*.parquet
       │
       ▼
┌──────────────────────────────────┐
│  Step 1: 计算订单簿变化量         │
│  Δbid1..10_vol, Δask1..10_vol    │
└──────────────┬───────────────────┘
               │
               ▼
┌──────────────────────────────────┐
│  Step 2: 计算OFI系列特征          │
│  ofi_l1, ofi_l5, ofi_l10         │
│  smart_ofi                       │
└──────────────┬───────────────────┘
               │
               ▼
┌──────────────────────────────────┐
│  Step 3: 计算滚动统计特征         │
│  ma_10, std_10, zscore           │
└──────────────┬───────────────────┘
               │
               ▼
┌──────────────────────────────────┐
│  Step 4: 生成预测标签             │
│  threshold = α × σ               │
│  label = sign(future_return)     │
└──────────────┬───────────────────┘
               │
               ▼
┌──────────────────────────────────┐
│  Step 5: 计算动态协方差（可选）    │
│  cov(stock, index)               │
└──────────────┬───────────────────┘
               │
               ▼
       features_*.parquet
```

---

## 7. 实测结果示例

以 HK.00700 (腾讯控股) 2026-01-14 数据为例：

| 指标 | 数值 |
|------|------|
| 输入记录 | 1,231 |
| 输出记录 | 1,230 |
| 特征列数 | 37 |

**OFI特征统计**：

| 特征 | 均值 | 标准差 | 偏度 |
|------|------|--------|------|
| ofi_l1 | -72.1 | 32,967 | -0.09 |
| ofi_l5 | -0.6 | 15,319 | 0.52 |
| smart_ofi | 102.4 | 6,864 | 0.74 |

**标签分布（α=0.3, k=20）**：

| 类别 | 比例 |
|------|------|
| 上涨(1) | 30.4% |
| 平稳(0) | 37.7% |
| 下跌(-1) | 31.9% |

---

## 8. 与论文对齐

| 论文设定 | 本实现 | 对齐状态 |
|---------|--------|---------|
| 深度衰减加权 | α=0.5指数衰减 | ✅ |
| 撤单率修正 | 承诺强度权重 | ✅（近似实现）|
| 滚动窗口 W=100 | window=10 (OFI), 100 (协方差) | ✅ |
| 预测步长 k∈{20,50,100} | PREDICTION_HORIZONS=[20,50,100] | ✅ |
| 波动率自适应阈值 | threshold = α × σ | ✅ |
| 动态协方差 | rolling_cov(stock, index) | ✅ |

---

## 9. 后续步骤

本模块输出的特征数据将用于：

1. **`12_dataset_builder.py`** - 构建滑动窗口训练集（T=100步输入）
2. **`13_model_trainer.py`** - 模型训练（Transformer/CNN-LSTM）
3. **`14_backtest.py`** - 策略回测与经济价值评估

---

## 10. 注意事项

1. **数据对齐**：如果输入数据缺少6-10档，自动填充为0
2. **NaN处理**：第一条记录无法计算diff，自动剔除
3. **阈值单位**：threshold与future_return均为小数形式（0.001表示0.1%）
4. **协方差计算**：需要指数K线数据，如无则跳过
5. **标签截断**：最后k条记录无法计算future_return，标签为NaN
