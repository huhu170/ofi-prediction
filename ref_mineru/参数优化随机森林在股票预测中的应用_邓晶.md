# 参数优化随机森林在股票预测中的应用

邓 晶，李 路

（上海工程技术大学 数理与统计学院，上海 201620）

摘 要: 为了提高股票预测的正确率，参照股票研究的指标体系，以股票的相对强弱、变动速率、能量潮、异同移动平均线以及威廉指标五个纯技术指标作为股票预测的特征。通过网格搜索对随机森林的参数进行了优化，构建基于纯技术指标的和参数优化随机森林的股票预测模型，并以平安银行、万科、深振业 A、神州高铁、美丽生态2017 年 4 月 30 日到 2019 年 6 月 30 日所有交易日作为实验室数据，实验结果与原始随机森林、决策树以及支持向量机分类模型对比，证实了参数优化后的随机森林股票预测模型在模型评价中的准确率和 AUC 值都高于其他模型。

关键词: 随机森林；技术指标；参数优化；网格搜索；股价预测中图分类号: TP301.6 文献标识码: A DOI：10.3969/j.issn.1003-6970.2020.01.039本文著录格式：邓晶，李路. 参数优化随机森林在股票预测中的应用[J]. 软件，2020，41（01）：178182

# Application of Parametric Optimization Random Forests in Stock Forecasting

DENG Jing, LI Lu (School of Mathematics, Physics and Statistics, Shanghai University of Engineering Science, Shanghai 201620, China)

【Abstract】: In order to improve the accuracy of stock prediction, according to the index system of stock research, RSI, ROC, OBV, MACD and Williams $\% \mathrm { R }$ are taken as the characteristics of stock prediction.The parameters of the random forest were optimized through grid search, and a stock prediction model based on pure technical indicators and parametric optimized random forest was constructed. All trading days from April 30, 2017 to June 30, 2019 were taken as laboratory data by Ping An Bank, Vanke, SHENZHEN ZHENYE (GROUP) CO.LTD, China High-speed Railway and Beautiful Ecology. The experimental results are compared with the original random forest, decision tree and SVM classification models, and it is confirmed that the accuracy and AUC of the optimized random forest stock prediction model are higher than other models in model evaluation.

【Key words】: Random forest; Technical indicators; Parametric optimization; Grid search; Stock price forecasting

# 0 引言

金融数据越来越多，投资者要想通过投资股票获得收益，需学会有效的从这些复杂的数据中分析股票的涨跌趋势。股票价格经常受到很多因素的影响，从基本面分析到技术分析再到量化投资，技术指标在股票预测中发挥着越来越重要的作用。而量化投资作为一种主动性投资策略，相对于传统型的投资策略，具有纪律性、系统性、及时性、准确性、分散化等优点。

近年来，基于决策树、随机森林、支持向量机、神经网络等机器学习算法的量化投资策略层出不穷，为了给投资者带来更好的效益，股票价格的涨跌（高收益的投资模型）自然也成为了国内外学者的热点研究对象。到目前为止，众多学者建立了不同的股票预测模型。覃思乾[1]（2006）应用灰色系统理论建立 GM（1，1）预测模型对股票价格变化进行预测，比用 ARIMA 模型进行预测具有更高的精确度；张晨希[2]（2006）等使用支持向量机对某上市公司股票走势进行预测，测试表明预测的精度明显高于采用 BP 算法等传统神经网络分类方法的测试结果；谢国强[3]（2012）提出了利用粒子群算法优化的支持向量回归模型对股票价格预测，实验仿真结果显示其训练集和测试集的平均相对误差比BP 神经网络分别减小了 $4 9 . 5 \%$ 和 $2 6 . 3 \%$ 。王淑燕[4]（2016）等通过分析国内外量化选股模型采用的指标体系，提出了 8 因子选股模型指标体系，并使用随机森林算法实现了对2013年4月股票涨跌情况较高精确度的预测。除了量化投资以外，随机森林算法在人脸识别[5]、系统检测[6-7]、文本分类[8]等多个领域都有着广泛的应用。为了探究随机森林算法在纯技术指标下对股价涨跌预测的精确率，本文从国内较成熟的选股指标体系出发，选取了五个纯技术指标，并建立一个基于随机森林的股价涨跌预测模型，为投资者提供精确的股票涨跌参考依据。

# 1 随机森林模型结构和原理介绍

随机森林算法是一种集成学习方法，随机森林的基分类器是决策树，而决策树是通过把样本从根节点排列到某个叶子节点来分类样本数据，主要过程包括特征选择、决策树的生成与决策树的剪枝。当数据中噪声或特征过多时，决策树容易出现对训练集的过拟合问题，而最新的研究表明[9]，构造多个分类器或回归器的集成算法可以提高分类或预测的准确率。随机森林算法是一种利用多个决策树分类器进行分类和预测的方法，可以用于处理回归、分类、聚类以及生存分析等问题，当随机森林应用于分类或回归问题时，就是由多个分类树或回归树集成的分类器，主要利用多个子样本的不同特征组建多个决策树，然后对每个样本进行预测得出最终类标签。

假定给定训练数据集为 $D = \{ ( x _ { 1 } , y _ { 1 } ) , ( x _ { 2 } , y _ { 2 } ) , \cdots ,$ ,$( x _ { N } , y _ { \mathrm { N } } ) \big \}$ ， $x _ { i } = ( x _ { i } ^ { ( 1 ) } , x _ { i } ^ { ( 2 ) } , \cdots , x _ { i } ^ { ( n ) } ) ^ { T }$ 为第 $i$ 个样本的特征向量， $n$ 为样本特征的个数， $y = ( y _ { 1 } , y _ { 2 } , \cdots , y _ { N } )$ ，$y _ { i } \in \{ 1 , 2 , \cdots K \}$ 为 标 签 向 量 或 类 别 向 量 ，$i = 1 , 2 , \cdots , N$ ， $N$ 为样本容量。当 $y$ 是包含在某一区间内的数量值时，称为回归树， $y$ 为样本得分；当 $y$ 是离散值时，称为分类树，此时 $y$ 为样本类别。算法步骤如下：

（1）从总体训练数据集 D 中有放回地重复随机抽取 $\frac { 2 } { 3 } N$ 个子样本数据集，之后随机选取 $n$ 个特征进行自助采样作为候选特征。

（2）再利用子样本数据分别训练，根据决策树信息增益的原则从候选特征中选择每棵树的每个节点，直到所有训练数据子集出现以下三种情形：a. 当前节点的样本数据为同一类；b. 当前特征是空集，或全部样本数据在所有特征上取值相同；c. 节点的样本数据为空。

（3）重复步骤 1）和步骤 2）多次，从而建立 $k$ 颗决策树构建随机森林。

（4）模型建立好后，利用各决策树对测试集进行测试，对于分类问题来说，最终对分类结果投票最多的那一类作为最终类标签；对于回归问题，则对得分取平均数。决策公式为： ( x ) arg ma H ix y $\sum _ { i = 1 } ^ { k } I ( h _ { i } ( x ) = \mathbf { y } _ { i } )$ 。其中 $h _ { i } ( x )$ 代表第 $i$ 棵决策树, $I$ 为指示性函数, $H ( x )$ 为随机森林最终决策模型。

# 2 随机森林股票预测参数优化

2015 年，聂敬云[10]等采用遗传算法对最小二乘支持向量机模型的惩罚因子和核函数参数进行优化，并将其与 BP 神经网络模型进行了比较，结果表明该预测模型具有更高的预测精度。2018 年，刘静[11]等提出一种蚁群优化与支持向量机相结合的入侵检测方法(ACO-SVM)，提高了算法的收敛性；黄金金[12]等建立 RS-SVM 传感器网络入侵检测算法，并用狼群算法优化参数降低误警率；陶颖新[13]等利用改进 PSO 算法得到模糊 RBF 神经网络的初始权值和阈值,然后对其进行二次优化得到最终的权值和阈值来提高对 MBR 膜通量的预测精度。2019 年，王燕、郭元凯[14]在参数寻优的过程中，结合网格搜索算法的思想，构建了 GS-XGBoost 金融预测模型，并与 XGBoost、SVM 对比，结果表明 GS-XGBoost模型在预测值与实际值的拟合度上表现最好。可见优化参数是提高模型泛化能力的有效方式，而随机森林是从原始数据中随机选取训练集和特征，使得算法具有很好抗噪能力，同时也给算法带来了很多参数，如决策树的棵数、树的最大深度、叶节点的最小样本数、最大特征数等，这些参数的选取对算法的性能有很大的干预作用。因此本文建立一个网格搜索与随机森林相结合的股票预测模型，利用网格搜索算法优化基于随机森林股票预测模型的参数。

随机森林算法可以使用 python 软件的 sklearn机器学习软件包来实现。本文利用网格搜索法穷举该算法的两个主要参数：决策树的数量（n_esti-mators）、树的最大深度（max_depth）。首先将确定森林中决策树的数量、树的最大深度的取值范围，将可能取值进行排列组合，列出所有组合生成“网格”。然后将各组参数用于随机森林训练，默认使用 3 折交叉验证对模型进行评估，即先将训练数据集 $D$ 划分为 3 个相等训练数据子集 $D _ { 1 } , D _ { 2 } , D _ { 3 }$ ，其中

$D = D _ { 1 } \cup D _ { 2 } \cup D _ { 3 } , ~ D _ { i } \cap D _ { j } = \emptyset , ~ i , j = 1 , 2 , 3 .$ 依 次 不重复的选取其中一个训练数据子集本作为测试集，其他 2 个训练数据子集用来训练，共重复 3 次，然后对这 3 次测试得分取均值作为最终的单一评估。这种方法的优势在于，保证每个训练数据子集都参与训练且都被测试，降低泛化误差。在拟合函数尝试了所有的参数组合后，最终得分最高的参数组合为最优参数组合。参数优化的随机森林股票预测实验流程图如图 1 所示。

基本步骤如下：

（1）获取股票价格等相关数据，计算得出技术类指标并设置标签组成数据集，并对数据进行分析和处理。

（2）将网格搜索算法应用于随机森林预测模型中，并使用交叉验证对各组参数的表现进行评估，得出最优参数组合。

（3）构建随机森林预测模型，然后使用测试集对参数优化后的随机森林股票预测模型进行测试，对比决策树和支持向量分类器，并作模型评价。

（4）根据股票涨跌情况的预测分析给投资者做出建议。

![](images/6e203f920c5a393923e45f98776dbee44277a661a3cb17cccce3f385ea5649d5.jpg)  
图 1 参数优化的随机森林股票预测流程  
Fig.1 Random forest stock forecasting process with Hyper-parametric optimization

# 3 特征选择和处理

量化选股策略的特征选择大致的分为基本面指标和技术面指标这两个方面。前者的代表为多因子模型，后者的代表为动量反转策略。传统的技术指标分析依赖投资者的经验，2015 年，梁淇俊，郑贵俊等[15]以 MACD、RSI、OBV 指标为交易信号，随机抽取一只股票进行择优，发现技术指标联合作用显著，因此本文建立了纯技术指标的多因子模型。通过原始数据计算得到相对强弱、变动速率、能量潮、异同移动平均线以及威廉指标五个纯技术指标作为随机森林选股模型的特征，五个纯技术指标含义以及指标的具体计算步骤参考《技术分析 A-Z》和百度百科。本文采用的技术指标及分类如表 1 所示，指标类别及名称来自通联数据 https://mall.datayes.com。

由各指标的统计量可知各个指标之间数据差异较大，特别是 OBV，其平均值往往远大于其他指标。为了消除标量之间由量纲引起的误差，所有数据特征都通过标准化处理，并去除了包含缺失值和奇异值的数据样本。

表 1 技术指标及分类  
Tab.1 Technical indicators and classification   

<table><tr><td>技术指标类别</td><td>技术指标名称及简称</td><td>关键参数</td></tr><tr><td>趋向指标</td><td>MACD指数平滑移动平均线</td><td>12,26,9</td></tr><tr><td>震荡指标</td><td>ROC变动率指标</td><td>14</td></tr><tr><td>能量指标</td><td>OBV能量潮</td><td>1</td></tr><tr><td>动量指标</td><td>Williams %R 威廉指标</td><td>14</td></tr><tr><td>强弱指标</td><td>RSI相对强弱</td><td>14</td></tr></table>

# 4 模型评价

# 4.1 准确率

准确率（accuracy）是最常见的评价指标，指被分类正确的样本数占所有样本数的百分比，通常来说，准确率是分类器对整体的判断能力，一般情况下准确率越高，分类器越好，但是准确率过高会产生过拟合现象导致预测效果不好。

# 4.2 ROC 曲线与 AUC 值

ROC 曲线也叫受试者工作特征曲线，它是根据机器学习的预测结果对样本排序，依次将每个样本划分为正类，再计算出真正例率和假正例率。以假正例率为纵轴、真正例率为横轴绘制的曲线即为ROC 曲线[9]。实际操作中只能用有限的测试数据样例来绘制 ROC 曲线，因此 ROC 曲线呈现的是一条不光滑的线，曲线下的面积为 AUC 值。AUC 值越大说明分类效果越好。

# 5 实验结果及分析

实验一，选取了 2017 年 4 月 30 日至 2019 年 6月 30 日的 A 股中具有代表性的万科证券每一个交易日的收盘价、开盘价、最高价、最低价作为分类的样本。将延后 14 天的收盘价对比当日收盘价，如果涨了，标签为 1，否则标签记为–1。实验数据源于优矿量化平台 https://uqer.datayes.com。经过特征的计算和处理后，最终实验数据一共含516 个交易日。

实验过程中，首先把数据集大概按照 $2 : 1$ 的比例随机分成训练集（345 个交易日）和测试集（171个交易日），然后用训练集分别对随机森林的决策树的数量以及最大特征数这两个主要参数做网格搜索，用 3 折交叉验证的测试集（115 个交易日）得分的平均值作为评估指标, 选取得分最高的参数组合构建最终的随机森林股票预测模型。根据数据设置参数树的棵树的范围： $1 { < } \mathbf { n }$ _estimators $< 3 4 5$ ，由于其对随机森林的影响不是很敏感，故步长设为 50，树的最大深度的范围为 $1 \leqslant \mathrm { m a x \_ d e p t h } \leqslant 5$ ，步长为1，网格搜索结果的可视化图形如图 2 所示。

![](images/1c2ace28a59338d8a80ecd1185cc332c988d5fefa7008b00fcc69a9288d5e8eb.jpg)  
图 2 网格搜索结果可视化  
Fig.2 Visualization of grid search results

通过网格搜索得出最优参数取值 $k { = } 1 5 0$ ， $m { = } 5$ 。从可视化图中也可以看出随着最大特征数的增大，模型得分越高。在确定模型后，保持其他变量相同，参数设为默认值，然后和最优参数实验测试准确率进行对比。测试结果见表2，参数优化后的随机森林股票预测模型测试的准确率约为 $7 7 \%$ ，比默认值高 $2 \%$ 左右，可见参数优化后的随机森林算法分类能力有所提高。

表 2 参数优化前后实验结果对比  
Tab.2 Comparison of experimental results before and after Hyper-parametric optimization   

<table><tr><td></td><td>n_estimators</td><td>max_depth</td><td>准确率</td></tr><tr><td>默认值</td><td>10</td><td>5</td><td>0.7485</td></tr><tr><td>参数优化</td><td>150</td><td>5</td><td>0.7661</td></tr></table>

2013 年，刘道文等[16]在分析支持向量机的预测基本原理基础上,以交叉验证法确定了回归的最佳参数并对股票价格指数进行预测, 研究结果表明基于支持向量机预测法能较准确地反映股票价格指数的变化趋势。为了进一步检验在纯技术指标下，参数优化后的随机森林对股票分类的效果，本文在构造参数优化随机森林股票预测模型的同时分别与原始参数的随机森林、决策树以及支持向量机对股票分类的实验结果进行比较。

如图 3 分别是根据支持向量机（a）、决策树（b）、原始随机森林（c）、参数优化后的随机森林（d）四个不同算法的训练结果画出来的 ROC 曲线图，横坐标代表“假正例率（FPR）”，纵坐标代表“真正例率（TPR）”，从图 2 中可以粗略的看出当 TPR 在同一水平线上时，参数优化后的随机森林预测的假正例率最低，原始随机森林次之，支持向量机最差。同时，四者的 AUC 值分别是 0.53、0.73、0.82、0.85，可见在纯技术指标下，随机森林对万科证券预测的泛化能力是相对较优的。

实验二为了证明随机森林的参数优化对股票预测的有效性，实验又计算获得平安银行、深振业 A、神州高铁、美丽生态四个证券公司从 2017 年 4 月30 日至 2019 年 6 月 30 日的每一个交易日的数据，分别预测五个证券公司股票的涨跌，表 3 是不同股票预测的实验结果，结果显示五个证券公司在参数优化后随机森林的预测下都达到较高的准确率，其中平安银行预测的准确率最高，比原始随机森林的预测准确率高出大约 $6 \%$ 。其他各证券公司在参数优化后的随机森林的预测下，准确率都比原始随机森林、决策树和支持向量机高，这进一步说明了随机森林股票预测模型的优良性和参数优化的有效性。

最后从预测的结果分析股票的涨跌情况，如果分类结果为 1，则代表该股票 14 天后仍旧保持涨的趋势，–1 则代表 14 天后股票即将下跌。从预测结果中可以得到股票在某一段时间内持续上涨，如第

![](images/1350618803bc191322c7292159c7f8fc0f3da0d8559652ff8dc31c1428aced9b.jpg)  
图 3 ROC 曲线图Fig.3 ROC curve

表 3 不同股票预测实验结果  
Tab.3 Experimental results of different stock prediction   

<table><tr><td>证券简称</td><td>支持向量机</td><td>决策树</td><td>原始随 机森林</td><td>参数优化后 的随机森林</td></tr><tr><td>平安银行</td><td>0.5977</td><td>0.6568</td><td>0.7751</td><td>0.8343</td></tr><tr><td>万科</td><td>0.5965</td><td>0.6316</td><td>0.7485</td><td>0.7661</td></tr><tr><td>深振业A</td><td>0.5630</td><td>0.6222</td><td>0.7333</td><td>0.7481</td></tr><tr><td>神州高铁</td><td>0.6456</td><td>0.6392</td><td>0.7342</td><td>0.7405</td></tr><tr><td>美丽生态</td><td>0.6024</td><td>0.6625</td><td>0.7108</td><td>0.7590</td></tr></table>

300-400 个数据样本代表数据集中 2018 年 7 月 31号至 2018 年 12 月 24 号的所有交易日，因此投资者可以在股票持续上涨期间持仓，待到下跌时平仓获利。

# 6 结语

本文针对股票预测问题，提出了基于随机森林的股价涨跌预测模型，一方面，由于基本面的指标更新比较慢，也为了防止投资行为过度依赖经验，构造多个纯技术指标对股票预测，另一方面用网格搜索的方法对随机森林的参数进行优化。最终通过对不同股票进行股价涨跌的实验发现在多个纯技术指标下，参数优化后的随机森林对股票的预测模型相对更具有可靠性，能为股民提供好的投资参考，同时也体现了股票市场的可预测性。但中国股市不断发展，在未来的研究中，对指标的构造和选取以及算法的优化还需继续完善。

# 参考文献

[1] 覃 思 乾 . 股 价 预 测 的 GM(1, 1) 模 型 [J]. 统 计 与 决 策 ,2006(06): 22-23.  
[2] 张晨希, 张燕平, 张迎春, 等. 基于支持向量机的股票预测[J]. 计算机技术与发展, 2006(06): 35-37.  
[3] 谢国强. 基于支持向量回归机的股票价格预测[J]. 计算机仿真, 2012, 29(04): 379-382.  
[4] 王淑燕, 曹正凤, 陈铭芷. 随机森林在量化选股中的应用研究[J]. 运筹与管理, 2016, 25(03): 163-168+177.  
[5] 全雪峰. 基于奇异熵和随机森林的人脸识别[J]. 软 件,2016, 37(02): 35-38.  
[6] 刘阳, 杜华军, 岳子涵, 等. 基于随机森林的无人机检测方法[J]. 计算机工程与应用, 2019, 55(07): 162-167.  
[7] 卢晓勇, 陈木生. 基于随机森林和欠采样集成的垃圾网页检测. 计算机应用, 2016, 36(3): 731-734.  
[8] 刘勇, 兴艳云. 基于改进随机森林算法的文本分类研究与应用[J]. 计算机系统应用, 2019, 28(05): 220-225.  
[9] 周志华. 机器学习[M]. 北京: 清华大学出版社, 2016  
[10] 聂敬云, 李春青, 李威威, 等. 关于遗传算法优化的最小二乘支持向量机在MBR仿真预测中的研究[J]. 软件, 2015,36(5): 40-44.  
[11] 刘静, 杨正校. 改进ACO-SVM在网络入侵检测中的应用[J].软件, 2018, 39(10): 57-59.  
[12] 黄金金, 陈晶, 张鲲. 基于RS-SVM的无线传感器网络安全的应用研究[J]. 软件, 2018, 39(11): 18-20.  
[13] 陶颖新, 李春青, 苏华. 基于改进的PSO和模糊RBF神经网络的MBR膜污染预测[J]. 软件, 2018, 39(8): 52-56.  
[14] 王燕, 郭元凯. 改进的XGBoost模型在股票预测中的应用[J/OL].计算机工程与应用, 2019-09-03: 1-10.  
[15] 梁淇俊, 郑贵俊, 徐守萍. 基于生存分析的择时策略择优体系研究——以技术指标交易信号为例[J]. 金融经济学研究, 2015, 30(01): 96-106.  
[16] 刘道文, 樊明智. 基于支持向量机股票价格指数建模及预测[J]. 统计与决策, 2013(02): 76-78.